{% extends "base.html" %}
{% load static %}


{% block title %}{{ product.name }} - InstrumentStore{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'products/css/product.css' %}">
{% endblock %}

{% block breadcrumbs %}
<!-- Start Breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6 col-12">
                <div class="breadcrumbs-content">
                    <h1 class="page-title">Single Product</h1>
                </div>
            </div>
            <div class="col-lg-6 col-md-6 col-12">
                <ul class="breadcrumb-nav">
                    <li><a href="{% url 'products:home' %}"><i class="lni lni-home"></i> Home</a></li>
                    <li><a href="{% url 'products:product_list' %}">Shop</a></li>
                    <li>{{ product.name }}</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- End Breadcrumbs -->
{% endblock %}

{% block content %}
<!-- Start Item Details -->
<section class="item-details section">
    <div class="container">
        <div class="top-area">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-12 col-12">
                    <div class="product-images">
                        <main id="gallery">
                            <div class="main-img">
                                {% if product.image %}
                                <img src="{{ product.image.url }}" id="current" alt="{{ product.name }}">
                                {% else %}
                                <img src="https://via.placeholder.com/600x600" id="current" alt="{{ product.name }}">
                                {% endif %}
                            </div>
                            <div class="images">
                                {% if product.image %}
                                <img src="{{ product.image.url }}" class="img" alt="{{ product.name }}">
                                {% endif %}
                                
                                {% for img in product_images %}
                                <img src="{{ img.image.url }}" class="img" alt="{{ product.name }}">
                                {% endfor %}
                            </div>
                        </main>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 col-12">
                    <div class="product-info"> 
                        <h2 class="title">{{ product.name }}</h2>
                        <p class="category"><i class="lni lni-tag"></i> Category:<a href="{% url 'products:product_list' %}?category={{ product.category.id }}">{{ product.category.name }}</a></p>
                        <div class="demo-section">
                            <div class="flash-sale-header" id="live-header">
                                <div class="flash-sale-title">
                                    <span class="flash-icon">‚ö°</span>
                                    <span class="flash-text">FLASH SALE</span>
                                </div>
                                <div class="countdown-section">
                                    <div class="countdown-label">
                                        <span class="clock-icon">üïê</span>
                                        <span>K·∫æT TH√öC TRONG</span>
                                    </div>
                                    {% if flash_sale_end %}
                                    <div class="flash-countdown" data-end="{{ flash_sale_end|date:'U' }}">
                                        <div class="time-box hours">00</div>
                                        <div class="time-box minutes">00</div>
                                        <div class="time-box seconds">00</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <h3 class="price">
                            {% if flash_sale %}
                                {{ flash_sale.flash_price|floatformat:0 }}‚Ç´
                                <span>{{ product.original_price|floatformat:0 }}‚Ç´</span>
                            {% elif product.discount_percent > 0 %}
                                {{ product.price|floatformat:0 }}‚Ç´
                            <span>{{ product.original_price|floatformat:0 }}‚Ç´</span>
                            {% else %}
                                {{ product.price|floatformat:0 }}‚Ç´
                            {% endif %}


                    <!-- badge -->
                            {% if flash_sale %}
                            <span class="discount-tag">
                              -{{ flash_sale.discount_percent }}%
                            </span>
                            {% elif product.discount_percent > 0 %}
                                <span class="discount-tag">-{{ product.discount_percent }}%</span>
                            {% elif product.is_new %}
                                <span class="discount-tag">New</span>
                            {% endif %}
                        </h3>
                        
                        <p class="info-text">{{ product.description|default:"No description available." }}</p>
                        <div class="row">
                          <div class="col-lg-4 col-md-4 col-12">
                            <div class="form-group quantity">
                                <label for="quantity">Quantity</label>
                                <div class="inner-content">
                                    <input class="button first" type="button" value="-" onclick="decreaseQuantity()">
                                    <input class="text" type="number" id="quantity" value="1" min="1">
                                    <input class="button last" type="button" value="+" onclick="increaseQuantity()">
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="bottom-content">
                            <div class="row align-items-end">
                                <div class="col-lg-4 col-md-4 col-12">
                                  <div class="button cart-button">
                                    <button class="btn btn-add-cart" style="width: 100%;">
                                        <i class="lni lni-cart"></i> Add to Cart
                                    </button>
                                </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-12">
                                  <div class="button cart-button">
                                    <button class="btn btn-buy-now" style="width: 100%;">
                                        Buy Now
                                    </button>
                                </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-12">
                                    <div class="wish-button">
                                        <button class="btn"><i class="lni lni-heart"></i> To Wishlist</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="product-details-info">
            <div class="single-block">
                <div class="row">
                    <div class="col-lg-6 col-12">
                        <div class="info-body custom-responsive-margin">
                            <h4>Details</h4>
                            <p>{{ product.description|default:"No description available." }}</p>
                            <h4>Specifications</h4>
                            <ul class="normal-list">
                                <li><span>Brand:</span> {% if product.brand %}{{ product.brand.name }}{% else %}N/A{% endif %}</li>
                                <li><span>Category:</span> {{ product.category.name }}</li>
                                <li><span>Stock:</span> {{ product.stock }}</li>
                                <li><span>SKU:</span> #{{ product.id }}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-6 col-12">
                        <div class="info-body">
                            <h4>Shipping Options:</h4>
                            <ul class="normal-list">
                                <li><span>Courier:</span> 2 - 4 days, 22.500‚Ç´</li>
                                <li><span>Local Shipping:</span> up to one week, 10.000‚Ç´</li>
                                <li><span>UPS Ground Shipping:</span> 4 - 6 days, 18.000‚Ç´</li>
                                <li><span>Unishop Global Export:</span> 3 - 4 days, 25.000‚Ç´</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reviews Section -->
            <div class="row">
                <div class="col-lg-4 col-12">
                    <div class="single-block give-review">
                        <h4>{{ average_rating|floatformat:1 }} (Overall)</h4>
                        <ul id="star-filters">
                            <!-- All Reviews -->
                            <li class="star-filter active" data-star="all">
                                <span>All ({{ total_reviews }})</span>
                            </li>
                            
                            <!-- 5 Stars -->
                            {% for filter in star_filters %}
                            <li class="star-filter" data-star="{{ filter.star }}">
                                <span>{{ filter.star }} stars ({{ filter.count }})</span>
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= filter.star %}
                                    <i class="lni lni-star-filled"></i>
                                    {% else %}
                                    <i class="lni lni-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </li>
                            {% endfor %}
                        </ul>
                        
                        <a href="{% url 'products:review_product' product.id %}" class="btn review-btn">
                            Leave a Review
                        </a>
                    </div>
                </div>
                
                <div class="col-lg-8 col-12">
                    <div class="single-block">
                        <div class="reviews">
                            <h4 class="title">Latest Reviews</h4>
                            
                            <!-- Reviews Container -->
                            <div id="reviews-container">
                                {% for review in reviews %}
                                <div class="single-review">
                                    <img src="{% static 'images/default-avatar.jpg' %}" alt="{{ review.user.username }}">
                                    
                                    <div class="review-info">
                                        <h4>
                                            {{ review.user.username }}
                                            <span>{{ review.created_at|date:"M d, Y" }}</span>
                                        </h4>
                                        
                                        <ul class="stars">
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= review.rating %}
                                                    <li><i class="lni lni-star-filled"></i></li>
                                                {% else %}
                                                    <li><i class="lni lni-star"></i></li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                        
                                        <p>{{ review.comment }}</p>
                                        
                                        {% if review.images.exists %}
                                        <div class="review-images">
                                            {% for img in review.images.all %}
                                                <img src="{{ img.image.url }}" alt="Review image">
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No reviews yet. Be the first to review this product!</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- End Item Details -->

<!-- Related Products -->
{% if related_products %}
<section class="trending-product section" style="margin-top: 12px;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="section-title">
                    <h2>Related Products</h2>
                    <p>Check out these similar products you might like</p>
                </div>
            </div>
        </div>
        <div class="row">
            {% for p in related_products %}
            <div class="col-lg-3 col-md-6 col-12">
                <div class="single-product">
                    <div class="product-image">
                        <img src="{% if p.image %}{{ p.image.url }}{% else %}https://via.placeholder.com/300x300{% endif %}" alt="{{ p.name }}">
                        {% if p.discount_percent > 0 %}
                        <span class="sale-tag">-{{ p.discount_percent }}%</span>
                        {% elif p.is_new %}
                        <span class="new-tag">New</span>
                        {% endif %}
                        <div class="button">
                            <a href="{% url 'products:product_detail' p.pk %}" class="btn"><i class="lni lni-cart"></i> View Details</a>
                        </div>
                    </div>
                    <div class="product-info">
                        <span class="category">{{ p.category.name }}</span>
                        <h4 class="title">
                            <a href="{% url 'products:product_detail' p.pk %}">{{ p.name }}</a>
                        </h4>
                        <ul class="review">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= p.avg_rating|default:0 %}
                                <li><i class="lni lni-star-filled"></i></li>
                                {% else %}
                                <li><i class="lni lni-star"></i></li>
                                {% endif %}
                            {% endfor %}
                            <li><span>{{ p.reviews.count|default:0 }} Review(s)</span></li>
                        </ul>
                        <div class="price">
                            <span>{{ p.price|floatformat:0 }}‚Ç´</span>
                            {% if p.discount_percent > 0 %}
                              <span class="discount-price">
                              {{ p.original_price|floatformat:0 }}‚Ç´
                              </span>
                               {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    // Product Image Gallery
    const current = document.getElementById("current");
    const opacity = 0.6;
    const imgs = document.querySelectorAll(".img");
    imgs.forEach(img => {
        img.addEventListener("click", (e) => {
            imgs.forEach(img => {
                img.style.opacity = 1;
            });
            current.src = e.target.src;
            e.target.style.opacity = opacity;
        });
    });

    // ===== STAR FILTER WITH AJAX =====
    document.addEventListener('DOMContentLoaded', function() {
        const starFilters = document.querySelectorAll('.star-filter');
        const reviewsContainer = document.getElementById('reviews-container');
        const productId = {{ product.id }};

        starFilters.forEach(filter => {
            filter.addEventListener('click', function() {
                // Remove active class from all filters
                starFilters.forEach(f => f.classList.remove('active'));
                
                // Add active class to clicked filter
                this.classList.add('active');
                
                // Get star rating
                const star = this.dataset.star;
                
                // Fetch filtered reviews
                fetchReviews(star);
            });
        });

        function fetchReviews(star) {
            // Show loading
            reviewsContainer.innerHTML = '<p class="text-center"><i class="lni lni-spinner lni-spin"></i> Loading...</p>';
            
            // AJAX request
            fetch(`{% url 'products:product_detail' product.pk %}?star=${star}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.reviews.length === 0) {
                    reviewsContainer.innerHTML = '<p class="text-muted">No reviews found for this filter.</p>';
                    return;
                }
                
                // Build HTML - FIX: Proper structure for CSS
                let html = '';
                data.reviews.forEach(review => {
                    html += `
                        <div class="single-review">
                            <img src="{% static 'images/default-avatar.jpg' %}" alt="${review.user}">
                            
                            <div class="review-info">
                                <h4>
                                    ${review.user}
                                    <span>${review.date}</span>
                                </h4>
                                
                                <ul class="stars">
                                    ${generateStars(review.rating)}
                                </ul>
                                
                                <p>${review.comment}</p>
                    `;
                    
                    // Add review images if exists - CRITICAL: Correct structure
                    if (review.images.length > 0) {
                        html += '<div class="review-images">';
                        review.images.forEach(img => {
                            html += `<img src="${img}" alt="Review image">`;
                        });
                        html += '</div>';
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                reviewsContainer.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                reviewsContainer.innerHTML = '<p class="text-danger">Error loading reviews. Please try again.</p>';
            });
        }

        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<li><i class="lni lni-star-filled"></i></li>';
                } else {
                    stars += '<li><i class="lni lni-star"></i></li>';
                }
            }
            return stars;
        }
    });

  // Quantity buttons
function increaseQuantity() {
    const input = document.getElementById('quantity');
    input.value = parseInt(input.value) + 1;
}

function decreaseQuantity() {
    const input = document.getElementById('quantity');
    if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
    }
}



/* Flash Sale Countdown */
document.addEventListener("DOMContentLoaded", function () {
  const el = document.querySelector(".flash-countdown");
  if (!el) return;

  const end = parseInt(el.dataset.end) * 1000;

  const tick = () => {
    const diff = end - Date.now();

    if (diff <= 0) {
      el.innerText = "‚è∞ ƒê√£ k·∫øt th√∫c";
      return;
    }

    const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
    const m = String(Math.floor(diff % 3600000 / 60000)).padStart(2, '0');
    const s = String(Math.floor(diff % 60000 / 1000)).padStart(2, '0');

    el.querySelector('.hours').textContent = h;
    el.querySelector('.minutes').textContent = m;
    el.querySelector('.seconds').textContent = s;
  };

  tick();
  setInterval(tick, 1000);
});
 </script>
{% endblock %}