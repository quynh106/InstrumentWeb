{% extends "base.html" %} {% block title %}{{ product.name }}{% endblock %}
{%block content %}
<div class="container my-4">
  <!-- PRODUCT TOP SECTION -->
  <div class="row">
    <!-- LEFT IMAGE -->
    <div class="col-md-6">
      {% if product.image %}
      <img
        src="{{ product.image.url }}"
        class="img-fluid rounded shadow-sm"
        alt="{{ product.name }}"
      />
      {% else %}
      <img
        src="https://via.placeholder.com/600x450"
        class="img-fluid rounded shadow-sm"
        alt="{{ product.name }}"
      />
      {% endif %}
    </div>

    <!-- RIGHT DETAILS -->
    <div class="col-md-6">
      <h2 class="fw-bold">{{ product.name }}</h2>

      <!-- Rating -->
      <p class="mb-1">
        <span class="fw-bold fs-5">⭐ {{ average_rating }} / 5</span>
        <span class="text-muted">({{ total_reviews }} reviews)</span>
      </p>

      <!-- Price -->
      <p class="text-primary fw-bold fs-3">
        ${{ product.price|floatformat:2 }}
      </p>

      <!-- Quantity Selector -->
      <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary" onclick="changeQty(-1)">
          −
        </button>
        <input
          id="qtyInput"
          type="number"
          class="form-control mx-2"
          value="1"
          min="1"
          style="width: 70px"
        />
        <button class="btn btn-outline-secondary" onclick="changeQty(1)">
          +
        </button>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        <a href="#" class="btn btn-success px-4">Add to Cart</a>
        <a href="#" class="btn btn-warning px-4">Buy Now</a>
      </div>

      <!-- Stock -->
      <p class="mt-3 text-muted">Stock: {{ product.stock }}</p>
    </div>
  </div>

  <hr />

  <!-- PRODUCT DESCRIPTION -->
  <h3>Description</h3>
  <p>{{ product.description|default:"No description available." }}</p>

  <hr />

  <!-- rate product -->

  <a
    href="{% url 'products:review_product' product.id %}"
    class="btn btn-warning my-3 d-inline-block"
  >
    <i class="bi bi-star-fill"></i> Rate Product
  </a>

  <!-- REVIEW SECTION -->
  <div class="mb-4">
    <h3 class="fw-bold">Customer Reviews</h3>

    <!-- Average rating + filter -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <span class="fw-bold fs-4">⭐ {{ average_rating }} / 5</span>
        <span class="text-muted">({{ total_reviews }} reviews)</span>
      </div>

      <!-- Star Filter Buttons -->
      <div class="btn-group">
        <a href="?star=all" class="btn btn-outline-primary btn-sm">All</a>
        <a href="?star=5" class="btn btn-outline-primary btn-sm">5 Stars</a>
        <a href="?star=4" class="btn btn-outline-primary btn-sm">4 Stars</a>
        <a href="?star=3" class="btn btn-outline-primary btn-sm">3 Stars</a>
        <a href="?star=2" class="btn btn-outline-primary btn-sm">2 Stars</a>
        <a href="?star=1" class="btn btn-outline-primary btn-sm">1 Star</a>
      </div>
    </div>

    <!--  reviews -->
    <div class="container my-5">
      {% for review in reviews %}
      <div class="border p-3 mb-3">
        <h5 class="mb-1">{{ review.user.username }}</h5>
        <small class="text-muted">
          Reviewed on {{ review.created_at|date:"Y-m-d" }}
        </small>

        <!-- Rating -->
        <div class="text-warning mb-2">
          {% for i in "12345"|make_list %}
            {% if forloop.counter <= review.rating %}
              ★
            {% else %}
              ☆
            {% endif %}
          {% endfor %}
        </div>
        

        <p class="mb-2">{{ review.comment }}</p>

        {% if review.image %}
        <img
          src="{{ review.image.url }}"
          class="img-thumbnail"
          style="width: 120px"
          alt="Review image"
        />
        {% endif %}
      </div>
      {% empty %}
      <p class="text-muted">No reviews yet.</p>
      {% endfor %}
    </div>

    <hr />
    <h3 class="fw-bold">Related Products</h3>

    <div class="row row-cols-2 row-cols-md-4 g-3 my-3">
      {% for p in related_products %}
      <div class="col">
        <a
          href="{% url 'products:product_detail' p.pk %}"
          class="text-decoration-none text-dark"
        >
          <div class="card border-0 shadow-sm h-100">
            {% if p.image %}
            <img
              src="{{ p.image.url }}"
              class="card-img-top"
              style="height: 150px; object-fit: cover"
            />
            {% else %}
            <img
              src="https://via.placeholder.com/300x200"
              class="card-img-top"
              style="height: 150px; object-fit: cover"
            />
            {% endif %}

            <div class="card-body p-2">
              <h6 class="text-truncate">{{ p.name }}</h6>
              <p class="fw-bold text-primary">${{ p.price }}</p>
            </div>
          </div>
        </a>
      </div>
      {% empty %}
      <p>No related products.</p>
      {% endfor %}
    </div>

    <!-- Quantity Logic -->
    <script>
      function changeQty(val) {
        let qty = document.getElementById("qtyInput");
        let newVal = parseInt(qty.value) + val;
        if (newVal >= 1) qty.value = newVal;
      }
    </script>
  </div>
</div>

{% endblock %}
