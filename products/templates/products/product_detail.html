{% extends "base.html" %} 
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'products/css/product.css' %}">
{% endblock %}

{% block title %}{{ product.name }}{% endblock %}
{%block content %}
<div class="container my-4">
  <!-- PRODUCT TOP SECTION -->
  <div class="row">
    <!-- LEFT IMAGE -->
    <div class="col-md-6">
      {% if product.image %}
      <!-- Main image -->
      <div class="border rounded p-2 mb-3 text-center">
        <img
          id="mainImage"
          src="{{ product.image.url }}"
          class="img-fluid rounded"
          style="max-height: 420px; object-fit: contain;"
          alt="{{ product.name }}"
        />
      </div>
    
      <!-- Thumbnails -->
<div class="d-flex gap-2">

  <!-- Thumbnail của ảnh MAIN -->
  <img
    src="{{ product.image.url }}"
    class="thumb border rounded active"
    style="width:70px;height:70px;object-fit:cover;cursor:pointer"
    data-src="{{ product.image.url }}"
  />

  <!-- Thumbnail ảnh phụ -->
  {% for img in product_images %}
  <img
    src="{{ img.image.url }}"
    class="thumb border rounded"
    style="width:70px;height:70px;object-fit:cover;cursor:pointer"
    data-src="{{ img.image.url }}"
  />
  {% endfor %}
</div>

    
      {% else %}
      <img
        src="https://via.placeholder.com/600x450"
        class="img-fluid rounded shadow-sm"
        alt="{{ product.name }}"
      />
      {% endif %}
    </div>
    

    <!-- RIGHT DETAILS -->
    <div class="col-md-6">
      <h2 class="fw-bold">{{ product.name }}</h2>

      <!-- Rating -->
      <p class="mb-1">
        <span class="fw-bold fs-5">⭐ {{ average_rating }} / 5</span>
        <span class="text-muted">({{ total_reviews }} reviews)</span>
      </p>

      <!-- Price -->
      <p class="text-primary fw-bold fs-3">
        ${{ product.price|floatformat:2 }}
      </p>

      <!-- Quantity Selector -->
      <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary" onclick="changeQty(-1)">
          −
        </button>
        <input
          id="qtyInput"
          type="number"
          class="form-control mx-2"
          value="1"
          min="1"
          style="width: 70px"
        />
        <button class="btn btn-outline-secondary" onclick="changeQty(1)">
          +
        </button>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        <a href="#" class="btn btn-success px-4">Add to Cart</a>
        <a href="#" class="btn btn-warning px-4">Buy Now</a>
      </div>

      <!-- Stock -->
      <p class="mt-3 text-muted">Stock: {{ product.stock }}</p>
    </div>
  </div>

  <hr />

  <!-- PRODUCT DESCRIPTION -->
  <h3>Description</h3>
  <p>{{ product.description|default:"No description available." }}</p>

  <hr />

  <!-- rate product -->

  <a
    href="{% url 'products:review_product' product.id %}"
    class="btn btn-warning my-3 d-inline-block"
  >
    <i class="bi bi-star-fill"></i> Rate Product
  </a>

  <!-- REVIEW SECTION -->
  <div class="mb-4">
    <h3 class="fw-bold">Customer Reviews</h3>

    <!-- Average rating + filter -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <span class="fw-bold fs-4">⭐ {{ average_rating }} / 5</span>
        <span class="text-muted">({{ total_reviews }} reviews)</span>
      </div>

      <!-- Star Filter Buttons -->
      {% with current_star=request.GET.star %}
      <div class="btn-group mb-3" role="group">
        <button class="btn btn-sm btn-outline-primary star-btn" data-star="all">
          All
        </button>
      
        {% for item in star_filters %}
        <button
          class="btn btn-sm btn-outline-primary star-btn"
          data-star="{{ item.star }}"
        >
          {{ item.star }} ⭐ ({{ item.count }})
        </button>
        {% endfor %}
      </div>
      
      {% endwith %}
    </div>

    <!--  reviews -->
    <div class="container my-5" id="review-list">
      {% for review in reviews %}
      <div class="border p-3 mb-3">
        <h5 class="mb-1">{{ review.user.username }}</h5>
        <small class="text-muted">
          Reviewed on {{ review.created_at|date:"Y-m-d" }}
        </small>

        <!-- Rating -->
        <div class="text-warning mb-2">
          {% for i in "12345"|make_list %} 
          {% if forloop.counter <= review.rating %}
           ★
            {% else %} 
            ☆ 
            {% endif %}
             {% endfor %}
        </div>

        <p class="mb-2">{{ review.comment }}</p>

        {% if review.images.exists  %}
<div class="d-flex gap-2">
  {% for img in review.images.all %}
  <img
    src="{{ img.image.url }}"
    class="img-thumbnail"
    style="width:100px"
  />
  {% endfor %}
</div>
{% endif %}

      </div>
      {% empty %}
      <p class="text-muted">No reviews yet.</p>
      {% endfor %}
    </div>

    <hr />
    <h3 class="fw-bold">Related Products</h3>

    <div class="row row-cols-2 row-cols-md-4 g-3 my-3">
      {% for p in related_products %}
      <div class="col">
        <a
          href="{% url 'products:product_detail' p.pk %}"
          class="text-decoration-none text-dark"
        >
          <div class="card border-0 shadow-sm h-100">
            {% if p.image %}
            <img
              src="{{ p.image.url }}"
              class="card-img-top"
              style="height: 150px; object-fit: cover"
            />
            {% else %}
            <img
              src="https://via.placeholder.com/300x200"
              class="card-img-top"
              style="height: 150px; object-fit: cover"
            />
            {% endif %}

            <div class="card-body p-2">
              <h6 class="text-truncate">{{ p.name }}</h6>
              <p class="fw-bold text-primary">${{ p.price }}</p>
            </div>
          </div>
        </a>
      </div>
      {% empty %}
      <p>No related products.</p>
      {% endfor %}
    </div>

    <!-- Quantity Logic -->
    <script>
      function changeQty(val) {
        let qty = document.getElementById("qtyInput");
        let newVal = parseInt(qty.value) + val;
        if (newVal >= 1) qty.value = newVal;
      }
    </script>
  </div>
</div>

<!-- scrip for filter star -->
<script>
  document.querySelectorAll(".star-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const star = this.dataset.star;
      const url = new URL(window.location.href);

      // thêm / đổi param star
      if (star === "all") {
        url.searchParams.delete("star");
      } else {
        url.searchParams.set("star", star);
      }

      fetch(url, {
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      })
        .then((res) => res.json())
        .then((data) => {
          const reviewList = document.getElementById("review-list");
          reviewList.innerHTML = "";

          if (data.reviews.length === 0) {
            reviewList.innerHTML =
              '<p class="text-muted">No reviews yet.</p>';
            return;
          }

          data.reviews.forEach((r) => {
            let stars = "★".repeat(r.rating) + "☆".repeat(5 - r.rating);

            // ✅ RENDER NHIỀU ẢNH
            let imagesHtml = "";
            if (r.images && r.images.length > 0) {
              imagesHtml = `
                <div class="d-flex gap-2 mt-2">
                  ${r.images
                    .map(
                      (img) =>
                        `<img src="${img}" class="img-thumbnail" style="width:100px;height:100px;object-fit:cover">`
                    )
                    .join("")}
                </div>
              `;
            }

            reviewList.innerHTML += `
              <div class="border p-3 mb-3">
                <h5 class="mb-1">${r.user}</h5>
                <small class="text-muted">Reviewed on ${r.date}</small>

                <div class="text-warning mb-2">${stars}</div>

                <p class="mb-2">${r.comment}</p>

                ${imagesHtml}
              </div>
            `;
          });
        });
    });
  });
</script>


<!-- Hover đổi ảnh & GIỮ ảnh khi thả chuột -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const mainImage = document.getElementById("mainImage");
    const thumbs = document.querySelectorAll(".thumb");

    thumbs.forEach((thumb) => {
      thumb.addEventListener("mouseenter", function () {
        // đổi ảnh chính
        mainImage.src = this.dataset.src;

        // bỏ active cũ
        thumbs.forEach((t) => t.classList.remove("active"));

        // set active mới
        this.classList.add("active");
      });
    });
  });
</script>


{% endblock %}